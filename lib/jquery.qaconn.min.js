(function($){var failTimeMultiplier=10;var defaultTemplateValues={rt:"--",ok:"--",fail:"--"};$.fn.qaconn=function(action){if(!this.instanceVars){this.instanceVars={qacCallInterval:null,opts:null,queue:[]}}if(action==="stop"){return stop(this)}if(action==="start"){return start(this)}if(action==="destroy"){return destroy(this)}if(action==="queue"){return this.instanceVars.queue}if(!this.instanceVars.opts&&!this.instanceVars.qacCallInterval){this.instanceVars.opts=$.extend({},$.fn.qaconn.defaults,action);start(this)}return this};$.fn.qaconn.destroy=function(queue,options){if(options.debug){console.debug("It's running destroy function!!! ")}return this};$.fn.qaconn.before=function(queue,options){if(options.debug){console.debug("It's running before function!!! ");console.debug("Before queue: "+queue)}};$.fn.qaconn.after=function(queue,lastCalc,options){if(options.debug){console.debug("It's running after function!!! ");console.debug("After queue: "+queue)}};$.fn.qaconn.qacCalculate=function(responseValues,options){if(!(responseValues&&responseValues.length>0)){return null}var sum=0,ok=0,fail=0;for(var i=0;i<responseValues.length;i++){var r=responseValues[i];if(r[0]==="ok"){sum+=r[1];ok++}else{sum+=options.failWeight.call(this,r[1],options);fail++}}return{rt:(sum/responseValues.length).toFixed(2),ok:ok,fail:fail}};$.fn.qaconn.failWeight=function(failTime,options){return failTime*failTimeMultiplier};$.fn.qaconn.defaults={ranges:{good:100,medium:150,low:200},remote:{url:"qaconn.htm",prosses:false},before:$(this).qaconn.before,after:$(this).qaconn.after,destroy:$(this).qaconn.destroy,interval:5000,queueLength:48,outputHTML:'<div class="qac-content ${qacClass}" title="${textLevel}: ${qacLevel}\n${textRT}: ${qacMed} ms\n${textOk}: ${qacResponseOk}\n${textFail}: ${qacResponseFail}"></div>',qacCalculate:$(this).qaconn.qacCalculate,failWeight:$(this).qaconn.failWeight,debug:false};function start(jqObject){qaConnInterval(jqObject);if(!jqObject.instanceVars.qacCallInterval){jqObject.instanceVars.qacCallInterval=window.setInterval(function(){qaConnInterval(jqObject)},jqObject.instanceVars.opts.interval);jqObject.html('<div class="qac-processing-info"></div><div class="qac-container"></div>')}return jqObject}function stop(jqObject){window.clearInterval(jqObject.instanceVars.qacCallInterval);jqObject.instanceVars.qacCallInterval=undefined;jqObject.find(".qac-container").html(fillTemplate(null,jqObject.instanceVars.opts));return jqObject}function destroy(jqObject){var options=jqObject.instanceVars.opts;var queue=jqObject.instanceVars.queue;stop(jqObject);var ret=options.destroy.call(this,queue,options);jqObject.empty();jqObject.unbind();return ret}function qacQuantizer(values,options){if(options.debug){console.debug("Quantizing level!!! "+level)}if(values.fail>=values.ok){return"bad"}var level=values.rt;if(level<=options.ranges.good){return"good"}if(level<=options.ranges.medium){return"medium"}if(level<=options.ranges.low){return"low"}if(level>options.ranges.low){return"bad"}return"unknown"}function fillTemplate(values,options){if(!values){values=defaultTemplateValues}if(options.debug){console.debug("Filling template!!! "+values)}var qq=qacQuantizer(values,options);return options.outputHTML.replace(/\${textLevel}/gi,$(this).qaconn.lang("level")).replace(/\${textRT}/gi,$(this).qaconn.lang("RT")).replace(/\${textOk}/gi,$(this).qaconn.lang("ok")).replace(/\${textFail}/gi,$(this).qaconn.lang("fail")).replace(/\${qacMed}/gi,values.rt).replace(/\${qacResponseOk}/gi,values.ok).replace(/\${qacResponseFail}/gi,values.fail).replace(/\${qacLevel}/gi,$(this).qaconn.lang(qq)).replace(/\${qacClass}/gi,"qac-image-"+qq)}function qaConnInterval(jqObject){var options=jqObject.instanceVars.opts;var queue=jqObject.instanceVars.queue;options.before.call(this,queue,options);if(options.debug){console.debug("+++++++ Call to "+options.remote.url+"!!!")}jqObject.find(".qac-processing-info").addClass("qac-processing");var time=new Date().getTime();$.ajax({url:options.remote.url,type:"POST",contentType:"application/json",data:JSON.stringify(queue),dataType:"json"}).done(function(data){if(options.debug){console.debug("Processing response!!!")}if(options.remote.process){queue=queue&&queue.length>0?queue:data}queue.push(["ok",new Date().getTime()-time])}).fail(function(){if(options.debug){console.debug("Server call error!!!")}queue.push(["fail",new Date().getTime()-time])}).always(function(){if(options.debug){console.debug("Queue call review!!!")}if(queue.length>options.queueLength){queue.shift()}jqObject.find(".qac-processing-info").removeClass("qac-processing");var result=options.qacCalculate.call(this,queue,options);options.after.call(this,queue,result,options);jqObject.find(".qac-container").html(fillTemplate(result,options));jqObject.instanceVars.queue=queue})}})(jQuery);